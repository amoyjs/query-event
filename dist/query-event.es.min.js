import{type}from"@amoy/common";var EventBus=/** @class */function(){function a(){this.handlers=[]}return a.prototype.add=function(a){return this.handlers.push(a),this},a.prototype.del=function(a){var b=this;return a?this.handlers.map(function(c,d){c===a&&b.handlers.splice(d,1)}):this.handlers=[],this},a.prototype.fire=function(a){if(this.handlers&&this.handlers.length)return this.handlers.map(function(b){"function"==typeof b&&b(a)}),this},a.prototype.clear=function(){this.handlers=[]},a}(),get=function(a,b){if("object"!==type(a))return a;for(var c,d=a,e=b.split("."),f=0,g=e.length;f<g;f++)if(c=e[f],c)if(d[c])d=d[c];else{d=void 0;break}return d},u={getFingers:function(a){return get(a,"data.originalEvent.touches.length")||1},getPoint:function(a,b){var c=Math.round;if("touch"===a.data.pointerType){var d=a.data.originalEvent.touches;return{x:c(d[b].pageX),y:c(d[b].pageY)}}return{x:c(a.data.global.x),y:c(a.data.global.y)}},getVector:function(a,b){var c=Math.round,d=c(a.x-b.x),e=c(a.y-b.y);return{x:d,y:e}},getLength:function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},getAngle:function(a,b){var c=Math.acos;if("object"!=typeof a||"object"!=typeof b)return void console.error("getAngle error!");// 判断方向，顺时针为 1 ,逆时针为 -1；
var d,e,f=0<a.x*b.y-b.x*a.y?1:-1,g=this.getLength(a),h=this.getLength(b),i=g*h;// 两个向量的模；
return 0===i?0:(d=a.x*b.x+a.y*b.y,e=d/i,1<e&&(e=1),-1>e&&(e=-1),c(e)*f);// 通过数量积公式可以推导出：
// cos = (x1 * x2 + y1 * y2)/(|a| * |b|);
},getAnchorPoint:function(a){return{x:a.x,y:a.y}}},RTOUCH_SUPPORT_EVENT=["touchstart","touchmove","touchend",// 拖动
"drag","dragstart","dragend",// 双指缩放
"pinch","pinchstart","pinchend",// 双指旋转
"rotate","rotatestart","rotateend",// 划动
"swipeleft","swiperight","swipeup","swipedown",// 短点击
"shorttap","longtap",// 单指缩放
"singlepinch","singlepinchstart","singlepinchend",// 单指旋转
"singlerotate","singlerotatestart","singlerotateend"],ORIGIN_EVENT_MAP=[{name:"pointerdown",fn:"_start"},{name:"pointermove",fn:"_move"},{name:"pointerup",fn:"_end"},{name:"pointerupoutside",fn:"_end"}],RTouch=/** @class */function(){var b=Math.round;function a(a){this.fingers=0,this.touching=!1,this.Bus={},this.target=a,this.initEventBus(),this.bindOriginEvent()}return a.prototype.initEventBus=function(){var a=this;RTOUCH_SUPPORT_EVENT.map(function(b){Object.defineProperty(a.Bus,b,{value:new EventBus})})},a.prototype.bindOriginEvent=function(){var a=this;ORIGIN_EVENT_MAP.map(function(b){var c=b.name,d=b.fn;a.target.interactive=!0,a.target.on(c,a[d],a)})},a.prototype._start=function(a){if(this.touching=!0,this.startTime=Date.now(),this.fingers=u.getFingers(a),this.singleBasePoint=u.getAnchorPoint(this.target),this.swipeStartPoint=this.startPoint=u.getPoint(a,0),1===this.fingers){// 单指且监听 singlePinch 时，计算向量模；
var b=u.getVector(this.startPoint,this.singleBasePoint);this.singlePinchStartLength=u.getLength(b)}else 1<this.fingers&&(// 双指操作时，记录第二触控点
// 计算双指向量；
// 计算向量模
this.secondPoint=u.getPoint(a,1),this.vector1=u.getVector(this.secondPoint,this.startPoint),this.pinchStartLength=u.getLength(this.vector1));this.fireEvent("touchstart",{origin:a})},a.prototype._move=function(a){if(this.touching){var b=u.getPoint(a,0);if(this.startPoint||(this.startPoint=b),1<this.fingers){// 双指操作， 触发 pinch 与 rotate
var c=u.getPoint(a,1),d=u.getVector(c,b),e=u.getLength(d);this.pinchStartLength&&(this.eventStart("pinch",{origin:a,delta:{scale:e/this.pinchStartLength}}),this.pinchStartLength=e),this.vector1&&(this.eventStart("rotate",{delta:{rotate:u.getAngle(this.vector1,d)},origin:a}),this.vector1=d)}// 触发 drag
this.eventStart("drag",{delta:{x:b.x-this.startPoint.x,y:b.y-this.startPoint.y},origin:a}),this.fireEvent("touchmove",{origin:a}),this.startPoint=b}},a.prototype._end=function(a){var c=Math.abs,d=this;if(this.touching=!1,this.fingers=u.getFingers(a),["pinch","drag","rotate","singlerotate","singlepinch"].map(function(b){d.eventEnd(b,{origin:a,type:b})}),this.swipeStartPoint){var e={x:b(a.data.global.x),y:b(a.data.global.y)},f=e.x-this.swipeStartPoint.x,g=e.y-this.swipeStartPoint.y,h=Date.now(),i="";30<f&&100>c(g)?i="swiperight":-30>f&&100>c(g)?i="swipeleft":30<g&&100>c(f)?i="swipedown":-30>g&&100>c(f)?i="swipeup":30>c(f)&&30>c(g)&&(500>h-this.startTime?i="shorttap":i="longtap"),i&&this.fireEvent(i,{origin:a})}this.fireEvent("touchend",{origin:a})},a.prototype.fireEvent=function(a,b){this.Bus[a]&&this.Bus[a].fire(Object.assign(b,{type:a,stopPropagation:function(){b.origin.stopPropagation()}}))},a.prototype.destory=function(){var a=this;ORIGIN_EVENT_MAP.map(function(b){var c=b.name,d=b.fn;a.target.off(c,a[d],a)})},a.prototype.eventStart=function(a,b){var c=a+"ing";this[c]?this.fireEvent(a,b):(this.fireEvent(a+"start",b),this[c]=!0)},a.prototype.eventEnd=function(a,b){var c=a+"ing",d=a+"end";this[c]&&(b.type=d,this.fireEvent(d,b),this[c]=!1)},a.prototype.on=function(a,b){var c=this,d=a.trim().toLowerCase();return d.split(" ").map(function(a){c.Bus[a].add(b)}),this},a.prototype.off=function(a,b){var c=this,d=a.trim().toLowerCase();return d.split(" ").map(function(a){b?c.Bus[a].del(b):c.Bus[a].clear()}),this},a}();function bind(a,b,c){RTOUCH_SUPPORT_EVENT.includes(b)?(!a.RTouch&&(a.RTouch=new RTouch(a)),a.RTouch.on(b,c)):(a.interactive=!0,a.on(b,c))}function off(a,b,c){RTOUCH_SUPPORT_EVENT.includes(b)&&a.RTouch?a.RTouch.off(b,c):(a.interactive=!0,a.off(b,c))}var event={/**
     * on
     *
     * event(s) binding
     *
     * @module query
     *
     * @param { String } name - event name
     * @param { Function } closure - event callback
     *
     * @example
     *
     * $(sprite).on('tap', () => {
     *     console.log('tapped')
     * })
     * // bind two events meanwhile
     * $(sprite).on('tap longtap', () => {
     *     console.log('tap longtap')
     * })
     */on:function(a,b){void 0===a&&(a=""),void 0===b&&(b=function(){});for(var c=a.split(" "),d=0;d<this.length;d++)for(var e=0;e<c.length;e++)this[d].interactive=!0,bind(this[d],c[e],b);return this},/**
     * off
     *
     * event(s) unbinding
     *
     * @module query
     *
     * @param { String } name - event(s) name
     *
     * @example
     *
     * $(sprite).on('tap')
     * // unbind two events meanwhile
     * $(sprite).on('tap longtap')
     */off:function(a){void 0===a&&(a="");for(var b=a.split(" "),c=0;c<this.length;c++)for(var d=0;d<b.length;d++)this[c].off(b[d]),off(this[c],b[d]);return this}};// @ts-ignore
window.query&&window.query.extend(event);export default event;export{event};
//# sourceMappingURL=query-event.es.min.js.map
